{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Empréstimos | Sistema EPI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="{% static 'gestao/css/styles.css' %}">
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">
            <div class="user-profile" onclick="toggleSettingsMenu()">
                <div class="user-avatar">
                    <i class="fas fa-user-circle"></i>
                    <img src="{% static 'path/para/sua-foto.jpg' %}" alt="" class="user-avatar-img">
                </div>
                <div class="user-info">
                    <span class="user-name">Lucas Silva</span>
                    <span class="user-role">Administrador</span>
                    <span class="user-email">email@dominio.com</span>
                </div>
                <i class="fas fa-chevron-down toggle-icon"></i>
            </div>
        </div>
    
        <div class="settings-menu" id="settings-menu">
            <ul>
                <li>
                    <a href="#">
                        <i class="fas fa-user-cog"></i>
                        <span>Configurações de Perfil</span>
                    </a>
                </li>
                <li>
                    <a href="#">
                        <i class="fas fa-key"></i>
                        <span>Alterar Senha</span>
                    </a>
                </li>
                <li>
                    <a href="#" onclick="confirmarLogout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Sair</span>
                    </a>
                </li>
            </ul>
        </div>
    
        <nav class="sidebar-nav">
            <ul>
                <li class="nav-item">
                    <a href="{% url 'admin_dashboard' %}" class="nav-link">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{% url 'cadastrar_epi' %}" class="nav-link">
                        <i class="fas fa-hard-hat"></i>
                        <span>Equipamentos</span>
                    </a>
                </li>
                <li class="nav-item active">
                    <a href="{% url 'cadastro_colaboradores' %}" class="nav-link">
                        <i class="fas fa-users"></i>
                        <span>Usuários</span>
                        <span class="badge bg-primary">5</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{% url 'emprestimo' %}" class="nav-link">
                        <i class="fas fa-exchange-alt"></i>
                        <span>Empréstimos</span>
                        <span class="badge bg-warning">3</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="confirmarLogout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Sair</span>
                    </a>
                </li>
              
            </ul>
        </nav>
    
        <div class="sidebar-footer">
            <div class="system-info">
                <i class="fas fa-circle text-success"></i>
                <span>Sistema Online</span>
            </div>
            <div class="version-info">
                v2.1.0
            </div>
        </div>
    </div>
    
   
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
    function toggleSettingsMenu() {
        const menu = document.getElementById("settings-menu");
        menu.classList.toggle("active");
        
        const icon = document.querySelector(".toggle-icon");
        icon.style.transform = menu.classList.contains("active") ? "rotate(180deg)" : "rotate(0)";
    }
    
    function confirmarLogout() {
        Swal.fire({
            title: 'Tem certeza?',
            text: "Você será desconectado do sistema!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sim, sair!',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = "/login";
            }
        });
    }
    
    // Para versão mobile - alternar sidebar
    function toggleSidebar() {
        document.querySelector('.sidebar').classList.toggle('active');
    }
    </script>

    <div class="main-content">
        <div class="container-fluid">
            <!-- Cabeçalho da Página -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-0">
                        <i class="fas fa-exchange-alt me-2 text-primary"></i>Gestão de Empréstimos
                    </h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Dashboard</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Empréstimos</li>
                        </ol>
                    </nav>
                </div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#novoEmprestimoModal">
                    <i class="fas fa-plus me-2"></i>Novo Empréstimo
                </button>
            </div>

            <!-- Mensagens do Sistema -->
            {% if messages %}
            <div class="alert-container mb-4">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    <i class="fas {% if message.tags == 'success' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %} me-2"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Card de Estatísticas -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title text-white-50">Empréstimos Ativos</h6>
                                    <h3 class="mb-0">45</h3>
                                </div>
                                <i class="fas fa-clipboard-list fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title text-white-50">Devolvidos</h6>
                                    <h3 class="mb-0">120</h3>
                                </div>
                                <i class="fas fa-check-circle fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title text-white-50">Pendentes</h6>
                                    <h3 class="mb-0">8</h3>
                                </div>
                                <i class="fas fa-clock fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title text-white-50">Atrasados</h6>
                                    <h3 class="mb-0">5</h3>
                                </div>
                                <i class="fas fa-exclamation-triangle fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

          

            <!-- Tabela de Empréstimos -->
            <div class="card w-75 mx-auto">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>Registro de Empréstimos
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Equipamento</th>
                                    <th>Colaborador</th>
                                    <th>Data Empréstimo</th>
                                    <th>Previsão Devolução</th>
                                    <th>Status</th>
                                    <th class="text-end">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaEmprestimos">
                                {% for emprestimo in emprestimos %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="user-avatar">
                                                <i class="fas fa-hard-hat"></i>
                                            </div>
                                            <div>
                                                <strong>{{ emprestimo.equipamento }}</strong>
                                                <div class="text-muted small">#{{ emprestimo.equipamento.id }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="user-avatar">
                                                <i class="fas fa-user"></i>
                                            </div>
                                            <div>
                                                <strong>{{ emprestimo.usuario.nome }}</strong>
                                                <div class="text-muted small">{{ emprestimo.usuario.matricula }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ emprestimo.data_emprestimo|date:"d/m/Y" }}</td>
                                    <td>{{ emprestimo.data_devolucao|date:"d/m/Y" }}</td>
                                    <td>
                                        <span class="status-badge status-{{ emprestimo.status|lower }}">
                                            {{ emprestimo.status }}
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <div class="btn-group" role="group">
                                            <a href="{% url 'editar_emprestimo' emprestimo.id %}" class="btn btn-sm btn-outline-primary action-btn" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button class="btn btn-sm btn-outline-danger action-btn" title="Excluir" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal" data-id="{{ emprestimo.id }}">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                            <a href="#" class="btn btn-sm btn-outline-success action-btn" title="Devolver">
                                                <i class="fas fa-undo"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-muted small">
                            Mostrando <strong>1</strong> a <strong>10</strong> de <strong>45</strong> registros
                        </div>
                        <nav aria-label="Page navigation">
                            <ul class="pagination pagination-sm mb-0">
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Anterior</a>
                                </li>
                                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                <li class="page-item"><a class="page-link" href="#">2</a></li>
                                <li class="page-item"><a class="page-link" href="#">3</a></li>
                                <li class="page-item">
                                    <a class="page-link" href="#">Próxima</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
       


      <!-- Card de Filtros e Pesquisa -->
      <div class="card mb-4 w-75 mx-auto">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="search-container">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0">
                                <i class="fas fa-search text-muted"></i>
                            </span>
                            <input type="text" id="searchInput" class="form-control border-start-0" placeholder="Pesquisar...">
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="filterStatus">
                        <option value="">Todos os status</option>
                        <option value="Ativo">Ativos</option>
                        <option value="Pendente">Pendentes</option>
                        <option value="Atrasado">Atrasados</option>
                        <option value="Devolvido">Devolvidos</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="filterEquipamento">
                        <option value="">Todos os equipamentos</option>
                        <option value="Capacete">Capacete</option>
                        <option value="Luva">Luva</option>
                        <option value="Bota">Bota</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100">
                        <i class="fas fa-filter me-2"></i>Filtrar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Modal Novo Empréstimo -->
    <div class="modal fade" id="novoEmprestimoModal" tabindex="-1" aria-labelledby="novoEmprestimoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="novoEmprestimoModalLabel">
                        <i class="fas fa-plus me-2"></i>Novo Empréstimo
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="modalEmprestimoForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="modalEquipamento" class="form-label">Equipamento *</label>
                                <select class="form-select" id="modalEquipamento" required>
                                    <option value="">Selecione um equipamento</option>
                                    <option value="1">Capacete de Segurança</option>
                                    <option value="2">Luvas de Proteção</option>
                                    <option value="3">Óculos de Segurança</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="modalColaborador" class="form-label">Colaborador *</label>
                                <select class="form-select" id="modalColaborador" required>
                                    <option value="">Selecione um colaborador</option>
                                    <option value="1">João Silva (MAT001)</option>
                                    <option value="2">Maria Souza (MAT002)</option>
                                    <option value="3">Carlos Oliveira (MAT003)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="modalDataEmprestimo" class="form-label">Data do Empréstimo *</label>
                                <input type="date" class="form-control" id="modalDataEmprestimo" required>
                            </div>
                            <div class="col-md-6">
                                <label for="modalDataDevolucao" class="form-label">Previsão de Devolução *</label>
                                <input type="date" class="form-control" id="modalDataDevolucao" required>
                            </div>
                            <div class="col-12">
                                <label for="modalObservacoes" class="form-label">Observações</label>
                                <textarea class="form-control" id="modalObservacoes" rows="2"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="salvarEmprestimo">
                        <i class="fas fa-save me-2"></i>Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Exclusão -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="confirmDeleteModalLabel">
                        <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Exclusão
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja excluir este empréstimo? Esta ação não pode ser desfeita.</p>
                    <div class="alert alert-warning mb-0">
                        <i class="fas fa-info-circle me-2"></i>O equipamento será marcado como disponível no sistema.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteButton">
                        <i class="fas fa-trash-alt me-2"></i>Excluir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
    <script>
        // Inicialização do Flatpickr para campos de data
        flatpickr("#modalDataEmprestimo, #modalDataDevolucao", {
            dateFormat: "d/m/Y",
            locale: "pt"
        });

        // Evento para excluir um empréstimo após confirmação
        document.querySelectorAll('[data-bs-target="#confirmDeleteModal"]').forEach(button => {
            button.addEventListener('click', function() {
                const emprestimoId = this.getAttribute('data-id');
                document.getElementById('confirmDeleteButton').setAttribute('data-id', emprestimoId);
            });
        });

        document.getElementById('confirmDeleteButton').addEventListener('click', function() {
            const emprestimoId = this.getAttribute('data-id');
            // Aqui você adicionaria a lógica para excluir o empréstimo
            alert('Empréstimo #' + emprestimoId + ' excluído com sucesso!');
            $('#confirmDeleteModal').modal('hide');
        });

        // Filtro de pesquisa
        document.getElementById('searchInput').addEventListener('keyup', function() {
            const searchTerm = this.value.toLowerCase();
            document.querySelectorAll('#tabelaEmprestimos tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });

        // Filtro por status
        document.getElementById('filterStatus').addEventListener('change', function() {
            const status = this.value;
            document.querySelectorAll('#tabelaEmprestimos tr').forEach(row => {
                if (!status) {
                    row.style.display = '';
                    return;
                }
                const rowStatus = row.querySelector('.status-badge').textContent.trim();
                row.style.display = rowStatus === status ? '' : 'none';
            });
        });
    </script>
</body>
</html>